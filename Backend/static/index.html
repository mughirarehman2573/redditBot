<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RedditBot</title>
<link href="https://unpkg.com/@picocss/pico@2/css/pico.min.css" rel="stylesheet">
<style>
  body {
    max-width: 1200px;
    margin: 2rem auto;
    font-family: "Segoe UI", system-ui, sans-serif;
    background: #fafafa;
    color: #222;
  }
  header.card {
    background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    color: #fff;
  }
  header h2 { margin: 0; }
  nav a {
    margin-right: .75rem;
    color: #fff !important;
    font-weight: 500;
  }
  nav a:hover {
    text-decoration: underline;
  }
  .hidden { display: none; }
  .card {
    padding: 1.5rem;
    border: 1px solid #e3e3e3;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    background: #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }
  .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
  .pill {
    padding: .3rem .7rem;
    border-radius: 20px;
    font-size: .8rem;
    background: #fff;
    color: #333;
    font-weight: 600;
  }
  .success { color: #2e7d32; font-weight: 500; }
  .error { color: #c62828; font-weight: 500; }
  table {
    width: 100%;
    border-collapse: collapse;
    border-radius: 8px;
    overflow: hidden;
  }
  table th, table td {
    padding: .75rem;
    text-align: left;
    border-bottom: 1px solid #eee;
  }
  table thead {
    background: #f5f7fa;
    font-weight: 600;
  }
  table tbody tr:hover {
    background: #f9f9f9;
  }
  button, input, select, textarea {
    border-radius: 6px !important;
  }
  button.primary, #saveModesBtn {
    background: #2575fc;
    color: #fff;
    border: none;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s ease;
  }
  button.primary:hover, #saveModesBtn:hover {
    background: #1258d6;
  }
  #logoutBtn {
    background: rgba(255,255,255,0.2);
    border: none;
    color: #fff;
  }
  #logoutBtn:hover { background: rgba(255,255,255,0.35); }
  #scheduleList li {
    padding: .5rem .75rem;
    margin: .3rem 0;
    background: #f7f9fc;
    border: 1px solid #e3e6ed;
    border-radius: 6px;
  }
  footer {
    margin-top:2rem;
    text-align:center;
    color:#777;
  }
  h3, h5 { color: #333; }
  .stats-details {
    margin-top: 1rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #2575fc;
  }
  .post-item, .comment-item {
    padding: 0.75rem;
    margin-bottom: 0.75rem;
    background: white;
    border-radius: 6px;
    border: 1px solid #e9ecef;
  }
  .post-title {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 0.5rem;
  }
  .comment-body {
    color: #34495e;
    line-height: 1.4;
  }
  .timestamp {
    font-size: 0.8rem;
    color: #7f8c8d;
    margin-top: 0.5rem;
  }
  .pagination {
    display: flex;
    justify-content: center;
    margin-top: 1rem;
    gap: 0.5rem;
  }
  .pagination button {
    padding: 0.5rem 1rem;
    border: 1px solid #ddd;
    background: white;
    cursor: pointer;
    border-radius: 4px;
  }
  .pagination button.active {
    background: #2575fc;
    color: white;
    border-color: #2575fc;
  }
  .activity-item {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    background: white;
  }
  .activity-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.5rem;
  }
  .post-link {
    color: #2575fc;
    text-decoration: none;
    font-weight: 500;
  }
  .post-link:hover {
    text-decoration: underline;
  }
  .post-content {
    margin: 0.5rem 0;
    color: #555;
  }
  .comment-content {
    background: #f8f9fa;
    padding: 0.75rem;
    border-radius: 6px;
    border-left: 3px solid #2575fc;
    margin-top: 0.5rem;
  }
  .empty-state {
    text-align: center;
    padding: 2rem;
    color: #777;
  }
  .pagination-info {
    text-align: center;
    margin: 1rem 0;
    font-weight: 500;
    color: #555;
  }
  .pagination-controls {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin: 1rem 0;
  }
  .pagination-controls button {
    padding: 0.5rem 1rem;
    border: 1px solid #2575fc;
    background: white;
    color: #2575fc;
    cursor: pointer;
    border-radius: 4px;
    font-weight: 500;
  }
  .pagination-controls button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .pagination-controls button:hover:not(:disabled) {
    background: #2575fc;
    color: white;
  }
  .schedule-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    background: white;
    border-radius: 6px;
    border: 1px solid #e9ecef;
  }
  .schedule-actions {
    display: flex;
    gap: 0.5rem;
  }
  .edit-form {
    margin-top: 1rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 6px;
    border-left: 3px solid #2575fc;
  }
  .account-actions {
    display: flex;
    gap: 0.5rem;
  }
  .delete-account-btn {
    background: #dc3545;
    color: white;
    border: none;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    cursor: pointer;
  }
  .delete-account-btn:hover {
    background: #c82333;
  }
</style>
</head>
<body>

<header class="card">
  <div style="display:flex;align-items:center;justify-content:space-between;">
    <h2>RedditBot</h2>
    <nav id="nav" class="hidden" style="display:flex;align-items:center;">
      <a href="#" data-view="dashboard">Dashboard</a>
      <a href="#" data-view="accounts">Accounts</a>
      <a href="#" data-view="stats">Stats</a>
      <a href="#" data-view="add">Add Account</a>
      <a href="#" data-view="schedule">Schedules</a>
      <span id="who" class="pill"></span>
      <button id="logoutBtn">Logout</button>
    </nav>
  </div>
</header>

<main>
  <!-- Login -->
  <section id="view-login" class="card">
    <h3>üîê Admin Login</h3>
    <form id="loginForm">
      <div class="grid-2">
        <label>Email <input type="email" name="email" required /></label>
        <label>Password <input type="password" name="password" required /></label>
      </div>
      <button type="submit" class="primary" style="width:100%;margin-top:1rem;">Login</button>
    </form>
    <p id="loginMsg"></p>
  </section>

  <!-- Dashboard -->
  <section id="view-dashboard" class="card hidden">
    <h3>üìä Dashboard</h3>
    <article class="card">
      <h5>Bot Modes</h5>
      <div class="grid-2">
        <label><input type="checkbox" id="modeCommenting"> Enable Commenting</label>
        <label><input type="checkbox" id="modePosting"> Enable Posting</label>
      </div>
      <div class="grid-2" style="margin-top:1rem;">
        <button id="saveModesBtn" class="primary">Save Modes</button>
        <span id="modesMsg"></span>
      </div>
    </article>
    <article class="card">
      <h5>Quick Stats</h5>
      <table>
        <tbody>
          <tr><td>Linked Accounts</td><td id="statAccounts">‚Äî</td></tr>
          <tr><td>Commenting</td><td id="statCommenting">‚Äî</td></tr>
          <tr><td>Posting</td><td id="statPosting">‚Äî</td></tr>
        </tbody>
      </table>
    </article>
  </section>

  <!-- Accounts -->
  <section id="view-accounts" class="card hidden">
    <h3>üë§ Your Reddit Accounts</h3>
    <table>
      <thead><tr><th>#</th><th>Username</th><th>Niche</th><th>Expires</th><th>Actions</th></tr></thead>
      <tbody id="accountsTbody"><tr><td colspan="5">Loading‚Ä¶</td></tr></tbody>
    </table>
    <p id="accountsMsg"></p>
  </section>

  <!-- Stats -->
  <section id="view-stats" class="card hidden">
    <h3>üìà Account Stats</h3>
    <div id="statsContainer" style="padding:1rem;background:#f9fafc;border-radius:8px;">Loading‚Ä¶</div>
  </section>

  <!-- Add -->
  <section id="view-add" class="card hidden">
    <h3>‚ûï Add Reddit Account</h3>
    <p>Click below to open Reddit login. After completing, you'll be redirected back here automatically.</p>
    <button id="getAuthUrlBtn" class="primary">Link Reddit Account</button>
    <p id="addMsg"></p>
  </section>

  <!-- Schedules -->
  <section id="view-schedule" class="card hidden">
    <h3>‚è∞ Manage Schedules</h3>
    <form id="scheduleForm" style="margin-bottom:1rem;">
      <label>Reddit Account <select id="scheduleAccount"></select></label>
      <label>Run At <input type="datetime-local" id="scheduleTime" required /></label>
      <label>Start Date <input type="date" id="scheduleStartDate" /></label>
      <label>End Date <input type="date" id="scheduleEndDate" /></label>
      <label>Action
        <select id="scheduleAction">
          <option value="comment">Comment</option>
          <option value="post">Post</option>
        </select>
      </label>
      <label>Prompt (optional) <textarea id="schedulePrompt"></textarea></label>
      <button type="submit" class="primary" style="margin-top:1rem;">Save Schedule</button>
    </form>
    <p id="scheduleMsg"></p>
    <h5>Your Schedules</h5>
    <div id="scheduleList"></div>
  </section>
</main>

<footer>
  <small>‚ö° RedditBot ‚Ä¢ FastAPI</small>
</footer>

<script>
// --- API Base ---
async function getApiBase() {
  try {
    const response = await fetch("/config");
    const data = await response.json();
    return data.API_BASE || "http://localhost:8000";
  } catch (error) {
    console.error("Error fetching API_BASE:", error);
    return "http://localhost:8000";
  }
}
async function ensureApiBase() {
  if (!window.API_BASE) {
    window.API_BASE = await getApiBase();
    console.log("üîß API_BASE ensured:", window.API_BASE);
  }
  return window.API_BASE;
}
(async function boot() {
  window.API_BASE = await getApiBase();
  console.log("‚úÖ API_BASE loaded:", window.API_BASE);
})();

// --- Utils ---
function token(){return localStorage.getItem('access_token')||'';}
function setToken(t){localStorage.setItem('access_token',t);}
function clearToken(){localStorage.removeItem('access_token');}
function parseJwt(t){try{return JSON.parse(atob(t.split('.')[1]));}catch{return null;}}
function setWho(user){document.getElementById('who').textContent=user?('Logged in as: '+user):'';}

const views={login:document.getElementById('view-login'),
             dashboard:document.getElementById('view-dashboard'),
             accounts:document.getElementById('view-accounts'),
             stats:document.getElementById('view-stats'),
             add:document.getElementById('view-add'),
             schedule:document.getElementById('view-schedule')};
const nav=document.getElementById('nav');
function show(v){Object.values(views).forEach(x=>x.classList.add('hidden'));
  views[v].classList.remove('hidden');
  if(v!=='login')nav.classList.remove('hidden');else nav.classList.add('hidden');
}

// --- Login ---
document.getElementById('loginForm').addEventListener('submit',async e=>{
  e.preventDefault();
  const msg=document.getElementById('loginMsg');
  msg.textContent='Logging in‚Ä¶';
  const form=new FormData(e.target);
  try{
    const API_BASE = await ensureApiBase();
    const res=await fetch(`${API_BASE}/auth/login`,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({email:form.get('email'),password:form.get('password')})
    });
    const data=await res.json();
    if(!res.ok)throw new Error(data.detail||'Login failed');
    setToken(data.access_token);
    setWho(data.user?.email || "User");
    msg.textContent='Logged in.';
    await initAfterLogin();
    show('dashboard');
  }catch(err){msg.innerHTML=`<span class="error">${err.message}</span>`;}
});
document.getElementById('logoutBtn').addEventListener('click',()=>{
  clearToken();setWho('');show('login');
});

// --- Nav ---
document.querySelectorAll('nav a[data-view]').forEach(a => {
  a.addEventListener('click',e=>{
    e.preventDefault();show(a.dataset.view);
    if(a.dataset.view==='accounts')loadAccounts();
    if(a.dataset.view==='stats')loadStats();
    if(a.dataset.view==='dashboard')refreshStats();
    if(a.dataset.view==='schedule'){loadScheduleAccounts();loadSchedules();}
  });
});

// --- Modes ---
const modeCommenting=document.getElementById('modeCommenting'),
      modePosting=document.getElementById('modePosting'),
      modesMsg=document.getElementById('modesMsg');
async function loadModes(){
  try{
    const API_BASE = await ensureApiBase();
    const r=await fetch(`${API_BASE}/user/settings`,{headers:{Authorization:'Bearer '+token()}});
    if(r.ok){const s=await r.json();modeCommenting.checked=!!s.commenting_enabled;modePosting.checked=!!s.posting_enabled;}
  }catch{}
}
async function saveModes(){
  modesMsg.textContent='Saving‚Ä¶';
  try{
    const API_BASE = await ensureApiBase();
    const r=await fetch(`${API_BASE}/user/settings`,{method:'PUT',
      headers:{'Content-Type':'application/json',Authorization:'Bearer '+token()},
      body:JSON.stringify({commenting_enabled:modeCommenting.checked,posting_enabled:modePosting.checked})});
    if(r.ok){modesMsg.innerHTML='<span class="success">Saved.</span>';}
  }catch{}
}
document.getElementById('saveModesBtn').addEventListener('click',saveModes);

// --- Stats ---
async function refreshStats(){
  let count='‚Äî';
  try{
    const API_BASE = await ensureApiBase();
    const r=await fetch(`${API_BASE}/stats/accounts`,{headers:{Authorization:'Bearer '+token()}});
  if(r.ok)count=(await r.json()).length;
  }catch{}
  document.getElementById('statAccounts').textContent=count;
  document.getElementById('statCommenting').textContent=modeCommenting.checked?'On':'Off';
  document.getElementById('statPosting').textContent=modePosting.checked?'On':'Off';
}

// --- Delete Account Function ---
async function deleteAccount(accountId) {
  try {
    const API_BASE = await ensureApiBase();
    const res = await fetch(`${API_BASE}/reddit/accounts/${accountId}`, {
      method: 'DELETE',
      headers: {
        'Authorization': 'Bearer ' + token()
      }
    });

    if (!res.ok) {
      const errorData = await res.json();
      throw new Error(errorData.detail || 'Failed to delete account');
    }

    return { success: true, message: 'Account deleted successfully' };
  } catch (error) {
    console.error('Error deleting account:', error);
    throw error;
  }
}

// --- Accounts ---
async function loadAccounts(){
  const tb=document.getElementById('accountsTbody'),msg=document.getElementById('accountsMsg');
  tb.innerHTML='<tr><td colspan="5">Loading‚Ä¶</td></tr>';
  try{
    const API_BASE = await ensureApiBase();
    const r=await fetch(`${API_BASE}/reddit/accounts`,{headers:{Authorization:'Bearer '+token()}});
    const accounts=await r.json();
    if(!r.ok)throw new Error(accounts.detail||'Failed');
    if(!accounts.length){tb.innerHTML='<tr><td colspan="5">No accounts.</td></tr>';return;}
    tb.innerHTML='';
    accounts.forEach((acc,i)=>{
      tb.insertAdjacentHTML('beforeend',
        `<tr>
           <td>${i+1}</td>
           <td>${acc.username}</td>
           <td><input type="text" value="${acc.niche||''}" data-niche="${acc.id}" style="width:120px"/>
             <button data-save-niche="${acc.id}">Save</button></td>
           <td>${new Date(acc.token_expires_at).toLocaleString()}</td>
           <td class="account-actions">
             <button class="delete-account-btn" data-delete-account="${acc.id}">Delete</button>
           </td>
         </tr>`);
    });

    // Add event listeners for niche saving
    tb.querySelectorAll('button[data-save-niche]').forEach(btn=>{
      btn.addEventListener('click',async()=>{
        const API_BASE = await ensureApiBase();
        const accId=btn.dataset.saveNiche;
        const niche=tb.querySelector(`input[data-niche="${accId}"]`).value;
        try{
          const r=await fetch(`${API_BASE}/reddit/accounts/${accId}/niche`,{
            method:'PUT',headers:{'Content-Type':'application/json',Authorization:'Bearer '+token()},
            body:JSON.stringify({niche})});
          if(!r.ok)throw new Error('Failed to save niche');
          msg.innerHTML='<span class="success">Niche updated.</span>';
        }catch(e){msg.innerHTML=`<span class="error">${e.message}</span>`;}
      });
    });

    // Add event listeners for account deletion
    tb.querySelectorAll('button[data-delete-account]').forEach(btn=>{
      btn.addEventListener('click',async()=>{
        const accId=btn.dataset.deleteAccount;
        const username = btn.closest('tr').querySelector('td:nth-child(2)').textContent;

        if(confirm(`Are you sure you want to delete the account "${username}"? This action cannot be undone.`)) {
          try {
            const result = await deleteAccount(accId);
            msg.innerHTML='<span class="success">Account deleted successfully.</span>';
            loadAccounts(); // Reload the accounts list
          } catch(e) {
            msg.innerHTML=`<span class="error">${e.message}</span>`;
          }
        }
      });
    });
  }catch(e){
    tb.innerHTML='<tr><td colspan="5">Error</td></tr>';
    msg.innerHTML=`<span class="error">${e.message}</span>`;
  }
}

// --- Global Stats ---
async function loadStats(){
  const container=document.getElementById('statsContainer');
  container.innerHTML='Loading‚Ä¶';
  try{
    const API_BASE = await ensureApiBase();
    const r=await fetch(`${API_BASE}/reddit/accounts`,{headers:{Authorization:'Bearer '+token()}});
    const accounts=await r.json();
    if(!accounts.length){container.innerHTML='No accounts.';return;}

    container.innerHTML='<h4>Select an account to view activity history:</h4>';

    for(const acc of accounts){
      const div=document.createElement('div');
      div.className='card';
      div.style.cursor = 'pointer';
      div.onclick = () => viewAccountStats(acc.id, acc.username);
      div.innerHTML=`
        <h4>${acc.username}</h4>
        <p>Niche: ${acc.niche||'No niche specified'}</p>
        <p>Click to view activity history</p>
      `;
      container.appendChild(div);
    }
  }catch(e){
    console.error('Error loading stats:', e);
    container.innerHTML='Error loading account information.';
  }
}

// View account stats in the stats section
async function viewAccountStats(accountId, username, page = 1) {
  const container = document.getElementById('statsContainer');
  container.innerHTML = '<div style="text-align: center; padding: 2rem;">Loading activity history...</div>';

  try {
    const API_BASE = await ensureApiBase();
    const r = await fetch(`${API_BASE}/stats/${accountId}?page=${page}`, {
      headers: {Authorization: 'Bearer ' + token()}
    });
    const data = await r.json();

    if (!r.ok || data.error) {
      container.innerHTML = `<div class="error">Error loading history: ${data.error || 'Unknown error'}</div>`;
      return;
    }

    // Format dates for display
    const formatDate = (timestamp) => {
      return new Date(timestamp * 1000).toLocaleString();
    };

    // Create activity history display
    let html = `
      <div style="margin-bottom: 1rem;">
        <button onclick="loadStats()" style="background: #ddd; border: none; padding: 0.5rem 1rem; border-radius: 4px; margin-bottom: 1rem;">
          ‚Üê Back to Accounts
        </button>
        <h4>Activity History for ${username}</h4>

        <!-- Pagination Info -->
        <div class="pagination-info">
          Showing page ${data.page} of ${data.total_pages} (${data.total_posts} total posts with comments)
        </div>

        <!-- Pagination Controls -->
        <div class="pagination-controls">
          <button onclick="viewAccountStats(${accountId}, '${username}', ${data.page - 1})"
                  ${data.page <= 1 ? 'disabled' : ''}>
            ‚Üê Previous
          </button>
          <button onclick="viewAccountStats(${accountId}, '${username}', ${data.page + 1})"
                  ${data.page >= data.total_pages ? 'disabled' : ''}>
            Next ‚Üí
          </button>
        </div>
      </div>
    `;

    if (data.posts && data.posts.length > 0) {
      data.posts.forEach(post => {
        html += `
          <div class="activity-item">
            <div class="activity-header">
              <a href="${post.url}" target="_blank" class="post-link">${post.title || 'Untitled Post'}</a>
              <span class="timestamp">${formatDate(post.created_utc)}</span>
            </div>

            ${post.body ? `<div class="post-content">${post.body}</div>` : ''}

            <div class="comment-content">
              <strong>Our Comment:</strong>
              <div class="comment-body">${post.comment}</div>
              <div class="timestamp">
                <a href="${post.comment_url}" target="_blank">View comment on Reddit</a>
              </div>
            </div>
          </div>
        `;
      });

      // Add pagination controls at the bottom too
      html += `
        <div class="pagination-controls" style="margin-top: 2rem;">
          <button onclick="viewAccountStats(${accountId}, '${username}', ${data.page - 1})"
                  ${data.page <= 1 ? 'disabled' : ''}>
            ‚Üê Previous
          </button>
          <button onclick="viewAccountStats(${accountId}, '${username}', ${data.page + 1})"
                  ${data.page >= data.total_pages ? 'disabled' : ''}>
            Next ‚Üí
          </button>
        </div>
      `;
    } else {
      html += `<div class="empty-state">No activity found for this account.</div>`;
    }

    container.innerHTML = html;

  } catch (e) {
    console.error('Error loading account stats:', e);
    container.innerHTML = `<div class="error">Failed to load activity history: ${e.message}</div>`;
  }
}

// --- OAuth ---
async function getAuthUrl(){
  const API_BASE = await ensureApiBase();
  const redirectUri = window.location.href.split("?")[0];
  console.log("üîó Using redirectUri:", redirectUri);
  const r = await fetch(`${API_BASE}/reddit/authorize?redirect_uri=${encodeURIComponent(redirectUri)}`, {
    headers:{Authorization:'Bearer '+token()}});
  const d = await r.json();
  if(!r.ok) throw new Error(d.detail||'Failed');
  console.log("‚úÖ Got auth_url:", d.auth_url);
  return d.auth_url;
}
document.getElementById('getAuthUrlBtn').addEventListener('click',async()=>{
  const msg=document.getElementById('addMsg');msg.textContent='Redirecting to Reddit‚Ä¶';
  try{
    const url=await getAuthUrl();window.location.href=url;
  }catch(e){msg.innerHTML=`<span class="error">${e.message}</span>`;}
});

// --- Handle OAuth callback ---
window.addEventListener('DOMContentLoaded',async()=>{
  const API_BASE = await ensureApiBase();
  console.log("üì• DOMContentLoaded with API_BASE:", API_BASE);
  const params=new URLSearchParams(window.location.search);
  const code=params.get('code');const state=params.get('state');
  console.log("üîç Callback params:",{code,state});
  if(code&&state){
    const msg=document.getElementById('addMsg');msg.textContent='Exchanging code‚Ä¶';
    try{
      const res=await fetch(`${API_BASE}/reddit/callback?code=${encodeURIComponent(code)}&state=${encodeURIComponent(state)}`,{
        headers:{Authorization:'Bearer '+token()}});
      const data=await res.json();
      console.log("üì¶ Callback response:",data);
      if(!res.ok)throw new Error(data.detail||'Callback failed');
      const linkRes=await fetch(`${API_BASE}/reddit/link_account`,{
        method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token()},
        body:JSON.stringify({username:data.username,access_token:data.access_token,refresh_token:data.refresh_token,expires_in:data.expires_in})});
      const linked=await linkRes.json();
      console.log("üì¶ Link response:",linked);
      if(!linkRes.ok)throw new Error(linked.detail||'Link failed');
      msg.innerHTML=`<span class="success">‚úÖ Connected as <b>${linked.username}</b>.</span>`;
      loadAccounts();
    }catch(e){console.error("‚ùå OAuth callback error:",e);msg.innerHTML=`<span class="error">${e.message}</span>`;}
    history.replaceState(null,'',window.location.pathname);
  }
});

// --- Schedule ---
async function loadScheduleAccounts(){
  const sel=document.getElementById('scheduleAccount');sel.innerHTML='';
  const API_BASE = await ensureApiBase();
  const r=await fetch(`${API_BASE}/reddit/accounts`,{headers:{Authorization:'Bearer '+token()}});
  const d=await r.json();d.forEach(acc=>{sel.insertAdjacentHTML('beforeend',`<option value="${acc.id}">${acc.username}</option>`);});
}
document.getElementById('scheduleForm').addEventListener('submit',async e=>{
  e.preventDefault();const msg=document.getElementById('scheduleMsg');
  try{
    const API_BASE = await ensureApiBase();
    const res=await fetch(`${API_BASE}/schedule/${document.getElementById('scheduleAccount').value}`,{
      method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+token()},
      body:JSON.stringify({run_at:document.getElementById('scheduleTime').value,
        start_date:document.getElementById('scheduleStartDate').value||null,
        end_date:document.getElementById('scheduleEndDate').value||null,
        action:document.getElementById('scheduleAction').value,
        prompt:document.getElementById('schedulePrompt').value})});
    const d=await res.json();
    if(!res.ok)throw new Error(d.detail||'Failed');
    msg.innerHTML='<span class="success">‚úÖ Saved schedule.</span>';loadSchedules();
  }catch(e){msg.innerHTML=`<span class="error">${e.message}</span>`;}
});

// Update schedule function
async function updateSchedule(scheduleId, payload) {
  try {
    const API_BASE = await ensureApiBase();
    const res = await fetch(`${API_BASE}/schedule/${scheduleId}`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token()
      },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.detail || 'Failed to update schedule');
    return data;
  } catch (error) {
    console.error('Error updating schedule:', error);
    throw error;
  }
}

// Delete schedule function
async function deleteSchedule(scheduleId) {
  try {
    const API_BASE = await ensureApiBase();
    const res = await fetch(`${API_BASE}/schedule/${scheduleId}`, {
      method: 'DELETE',
      headers: {
        'Authorization': 'Bearer ' + token()
      }
    });

    if (!res.ok) throw new Error('Failed to delete schedule');
    return true;
  } catch (error) {
    console.error('Error deleting schedule:', error);
    throw error;
  }
}

async function loadSchedules(){
  const container = document.getElementById('scheduleList');
  container.innerHTML = 'Loading schedules...';

  try {
    const API_BASE = await ensureApiBase();
    const r = await fetch(`${API_BASE}/schedule/`, {
      headers: {Authorization: 'Bearer ' + token()}
    });
    const schedules = await r.json();

    if (!r.ok) throw new Error(schedules.detail || 'Failed to load schedules');

    container.innerHTML = '';

    if (!schedules.length) {
      container.innerHTML = '<div class="empty-state">No schedules found.</div>';
      return;
    }

    schedules.forEach(schedule => {
      const scheduleItem = document.createElement('div');
      scheduleItem.className = 'schedule-item';
      scheduleItem.id = `schedule-${schedule.id}`;

      // Format dates for display
      const formatDate = (dateString) => {
        if (!dateString) return '‚Äî';
        return new Date(dateString).toLocaleString();
      };

      scheduleItem.innerHTML = `
        <div>
          <strong>${schedule.action}</strong> ‚Ä¢ ${schedule.account_name || schedule.account_id} ‚Ä¢
          ${schedule.niche || '‚Äî'} ‚Ä¢ ${formatDate(schedule.start_date)} ‚Üí ${formatDate(schedule.end_date)}
          ${schedule.prompt ? `<br><small>Prompt: ${schedule.prompt}</small>` : ''}
        </div>
        <div class="schedule-actions">
          <button class="edit-schedule" data-id="${schedule.id}">Edit</button>
          <button class="delete-schedule" data-id="${schedule.id}">Delete</button>
        </div>
      `;

      container.appendChild(scheduleItem);

      // Add event listeners for edit and delete
      scheduleItem.querySelector('.edit-schedule').addEventListener('click', () => {
        showEditForm(schedule);
      });

      scheduleItem.querySelector('.delete-schedule').addEventListener('click', async () => {
        if (confirm('Are you sure you want to delete this schedule?')) {
          try {
            await deleteSchedule(schedule.id);
            scheduleItem.remove();
            document.getElementById('scheduleMsg').innerHTML = '<span class="success">Schedule deleted successfully.</span>';
          } catch (error) {
            document.getElementById('scheduleMsg').innerHTML = `<span class="error">Error: ${error.message}</span>`;
          }
        }
      });
    });
  } catch (error) {
    console.error('Error loading schedules:', error);
    container.innerHTML = `<div class="error">Failed to load schedules: ${error.message}</div>`;
  }
}

function showEditForm(schedule) {
  // Remove any existing edit form
  const existingForm = document.querySelector('.edit-form');
  if (existingForm) {
    existingForm.remove();
  }

  const scheduleItem = document.getElementById(`schedule-${schedule.id}`);
  const editForm = document.createElement('div');
  editForm.className = 'edit-form';

  // Format datetime for input field
  const formatDateTime = (dateString) => {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toISOString().slice(0, 16);
  };

  editForm.innerHTML = `
    <h5>Edit Schedule</h5>
    <form id="editScheduleForm-${schedule.id}">
      <label>Run At <input type="datetime-local" name="run_at" value="${formatDateTime(schedule.run_at)}" required /></label>
      <label>Start Date <input type="date" name="start_date" value="${schedule.start_date || ''}" /></label>
      <label>End Date <input type="date" name="end_date" value="${schedule.end_date || ''}" /></label>
      <label>Action
        <select name="action">
          <option value="comment" ${schedule.action === 'comment' ? 'selected' : ''}>Comment</option>
          <option value="post" ${schedule.action === 'post' ? 'selected' : ''}>Post</option>
        </select>
      </label>
      <label>Prompt (optional) <textarea name="prompt">${schedule.prompt || ''}</textarea></label>
      <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
        <button type="submit" class="primary">Save Changes</button>
        <button type="button" class="cancel-edit">Cancel</button>
      </div>
    </form>
  `;

  scheduleItem.after(editForm);

  // Add event listeners
  const form = document.getElementById(`editScheduleForm-${schedule.id}`);
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const payload = {
      run_at: formData.get('run_at'),
      start_date: formData.get('start_date') || null,
      end_date: formData.get('end_date') || null,
      action: formData.get('action'),
      prompt: formData.get('prompt') || null
    };

    try {
      const updatedSchedule = await updateSchedule(schedule.id, payload);
      document.getElementById('scheduleMsg').innerHTML = '<span class="success">Schedule updated successfully.</span>';
      editForm.remove();
      loadSchedules(); // Reload schedules to show updated data
    } catch (error) {
      document.getElementById('scheduleMsg').innerHTML = `<span class="error">Error: ${error.message}</span>`;
    }
  });

  editForm.querySelector('.cancel-edit').addEventListener('click', () => {
    editForm.remove();
  });
}

// --- Init ---
async function initAfterLogin(){await loadModes();await refreshStats();}
(async function boot2(){if(token()){setWho("User");show('dashboard');initAfterLogin();}else show('login');})();
</script>
</body>
</html>